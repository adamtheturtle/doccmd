---
name: Release

on: workflow_dispatch

jobs:
  build:
    name: Publish a release
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      wheel_filename: ${{ steps.build-wheel.outputs.wheel_filename }}

    # Specifying an environment is strongly recommended by PyPI.
    # See https://github.com/pypa/gh-action-pypi-publish/tree/release/v1/?tab=readme-ov-file#trusted-publishing.
    environment: release

    permissions:
      # This is needed for PyPI publishing.
      # See https://github.com/pypa/gh-action-pypi-publish/tree/release/v1/?tab=readme-ov-file#trusted-publishing.
      id-token: write
      # This is needed for https://github.com/stefanzweifel/git-auto-commit-action.
      contents: write
      # This is needed for pushing Docker images to ghcr.io.
      packages: write

    steps:
      - uses: actions/checkout@v6
        with:
          # See
          # https://github.com/stefanzweifel/git-auto-commit-action?tab=readme-ov-file#push-to-protected-branches
          token: ${{ secrets.RELEASE_PAT }}
          # Fetch all history including tags.
          # Needed to find the latest tag.
          #
          # Also, avoids
          # https://github.com/stefanzweifel/git-auto-commit-action/issues/99.
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: '**/pyproject.toml'

      - name: Calver calculate version
        uses: StephaneBour/actions-calver@master
        id: calver
        with:
          date_format: '%Y.%m.%d'
          release: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get the changelog underline
        id: changelog_underline
        run: |
          underline="$(echo "${{ steps.calver.outputs.release }}" | tr -c '\n' '-')"
          echo "underline=${underline}" >> "$GITHUB_OUTPUT"

      - name: Update changelog
        id: update_changelog
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: "Next\n----"
          replace: |
            Next
            ----

            ${{ steps.calver.outputs.release }}
            ${{ steps.changelog_underline.outputs.underline }}
          include: CHANGELOG.rst
          regex: false

      - name: Check changelog was modified
        run: |
          if [ "${{ steps.update_changelog.outputs.modifiedFiles }}" = "0" ]; then
            echo "Error: No files were modified when updating changelog"
            exit 1
          fi

      - uses: stefanzweifel/git-auto-commit-action@v7
        id: commit
        with:
          commit_message: Bump CHANGELOG
          file_pattern: CHANGELOG.rst
          # Error if there are no changes.
          skip_dirty_check: true

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: ${{ steps.calver.outputs.release }}
          tag_prefix: ''
          commit_sha: ${{ steps.commit.outputs.commit_hash }}

      - name: Build a binary wheel and a source tarball
        id: build-wheel
        run: |
          sudo rm -rf dist/ build/
          git fetch --tags
          git checkout ${{ steps.tag_version.outputs.new_tag }}
          uv build --sdist --wheel --out-dir dist/
          WHEEL="$(ls dist/*.whl)"
          uv run --extra=release check-wheel-contents "${WHEEL}"
          echo "wheel_filename=${WHEEL}" >> "$GITHUB_OUTPUT"

      - name: Publish distribution ðŸ“¦ to PyPI
        # We use PyPI trusted publishing rather than a PyPI API token.
        # See https://github.com/pypa/gh-action-pypi-publish/tree/release/v1/?tab=readme-ov-file#trusted-publishing.
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true

      # We have a race condition.
      # In particular, we push to PyPI and then immediately try to install
      # the pushed version.
      # Here, we give PyPI time to propagate the package.
      - name: Install doccmd from PyPI
        uses: nick-fields/retry@v3
        with:
          timeout_seconds: 5
          max_attempts: 50
          command: uv pip install --refresh doccmd==${{ steps.calver.outputs.release }}

      - name: Set up Homebrew filename
        id: set-homebrew-filename
        run: |
          echo "filename=doccmd.rb" >> "$GITHUB_OUTPUT"

      # We still hit the race condition, so we have a retry here too.
      - name: Create a Homebrew recipe
        id: homebrew-create
        uses: nick-fields/retry@v3
        with:
          timeout_seconds: 5
          max_attempts: 50
          command: |
            uv run --no-cache --with="doccmd==${{ steps.calver.outputs.release }}" --extra=release poet --formula doccmd > ${{ steps.set-homebrew-filename.outputs.filename }}

      - name: Update Homebrew description
        id: update_homebrew_description
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: desc "Shiny new formula"
          replace: desc "Run tools against code blocks in documentation"
          include: ${{ steps.set-homebrew-filename.outputs.filename }}
          regex: false

      - name: Check Homebrew description was modified
        run: |
          if [ "${{ steps.update_homebrew_description.outputs.modifiedFiles }}" = "0" ]; then
            echo "Error: No files were modified when updating Homebrew description"
            exit 1
          fi

      - name: Push Homebrew Recipe
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          # See https://github.com/marketplace/actions/github-action-to-push-subdirectories-to-another-repo#usage
          # for how to get this token.
          # I do not yet know how to set this up to work with a
          # "Fine-grained personal access token", only a "Token (classic)" with "repo" settings.
          API_TOKEN_GITHUB: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        with:
          destination_branch: main
          source_file: ${{ steps.set-homebrew-filename.outputs.filename }}
          destination_repo: adamtheturtle/homebrew-doccmd
          user_email: adamdangoor@gmail.com
          user_name: adamtheturtle
          commit_message: Bump CLI Homebrew recipe

      - name: Strip leading zeros from version for pre-commit
        id: calver_stripped
        run: |
          tag="${{ steps.tag_version.outputs.new_tag }}"
          # Strip leading zeros from each numeric segment (e.g., v2025.12.08.4 -> v2025.12.8.4)
          stripped_tag=$(echo "v$tag" | sed -E 's/\.0+([0-9])/.\1/g')
          echo "tag=${stripped_tag}" >> "$GITHUB_OUTPUT"

      - name: Update Linux binary version
        id: update_linux_binary
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: (releases/download/)[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?
          replace: ${1}${{ steps.tag_version.outputs.new_tag }}
          include: README.rst
          regex: true

      - name: Check Linux binary version was modified
        run: |
          if [ "${{ steps.update_linux_binary.outputs.modifiedFiles }}" = "0" ]; then
            echo "Error: No files were modified when updating Linux binary version"
            exit 1
          fi

      - name: Update pre-commit rev
        id: update_precommit_rev
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: '(rev: )v[0-9]+\.[0-9]{1,2}\.[0-9]{1,2}(\.[0-9]+)?'
          replace: ${1}${{ steps.calver_stripped.outputs.tag }}
          include: README.rst
          regex: true

      - name: Check pre-commit rev was modified
        run: |
          if [ "${{ steps.update_precommit_rev.outputs.modifiedFiles }}" = "0" ]; then
            echo "Error: No files were modified when updating pre-commit rev"
            exit 1
          fi

      - name: Update Nix flake version in README
        id: update_nix_version
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: (github:adamtheturtle/doccmd/)[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?
          replace: ${1}${{ steps.tag_version.outputs.new_tag }}
          include: README.rst
          regex: true

      - name: Check Nix flake version was modified
        run: |
          if [ "${{ steps.update_nix_version.outputs.modifiedFiles }}" = "0" ]; then
            echo "Error: No files were modified when updating Nix flake version"
            exit 1
          fi

      - name: Update VERSION file for Nix flake
        run: |
          echo "${{ steps.tag_version.outputs.new_tag }}" > VERSION

      - uses: stefanzweifel/git-auto-commit-action@v7
        id: commit-readme
        with:
          commit_message: Replace version in README
          branch: main
          file_pattern: README.rst VERSION
          # Error if there are no changes.
          skip_dirty_check: true

      - name: Create Linux binary
        uses: sayyid5416/pyinstaller@v1
        with:
          python_ver: '3.13'
          pyinstaller_ver: ==6.12.0
          spec: bin/doccmd-wrapper.py
          requirements: '`echo ${{ steps.build-wheel.outputs.wheel_filename }} > requirements.txt
            && echo requirements.txt`'
          options: --onefile, --name "doccmd-linux"
          upload_exe_with_name: doccmd-linux
          clean_checkout: false

      - name: Create a GitHub release
        uses: ncipollo/release-action@v1
        with:
          # Use a specific artifact name (not a glob) so that we get a clear
          # error if the artifact does not exist for some reason.
          artifacts: dist/doccmd-linux
          artifactErrorsFailBuild: true
          tag: ${{ steps.tag_version.outputs.new_tag }}
          makeLatest: true
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          body: ${{ steps.tag_version.outputs.changelog }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            DOCCMD_VERSION=${{ steps.calver.outputs.release }}
          tags: |-
            ghcr.io/adamtheturtle/doccmd:${{ steps.calver.outputs.release }}
            ghcr.io/adamtheturtle/doccmd:latest

  build-windows:
    name: Build Windows binary and update winget
    needs: build
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.RELEASE_PAT }}
          fetch-depth: 0
          ref: ${{ needs.build.outputs.new_tag }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install pyinstaller==6.12.0
          pip install doccmd==${{ needs.build.outputs.new_tag }}

      - name: Build Windows binary
        run: |
          pyinstaller --onefile --name "doccmd-windows" bin/doccmd-wrapper.py

      - name: Upload Windows binary to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.build.outputs.new_tag }} dist/doccmd-windows.exe --clobber

      - name: Calculate SHA256 hash
        id: sha256
        run: |
          $hash = (Get-FileHash -Path dist/doccmd-windows.exe -Algorithm SHA256).Hash
          echo "hash=$hash" >> $env:GITHUB_OUTPUT

      - name: Checkout main branch for winget update
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.RELEASE_PAT }}
          ref: main

      - name: Create new winget manifest version directory
        run: |
          $version = "${{ needs.build.outputs.new_tag }}"
          $manifestDir = "winget/manifests/a/adamtheturtle/doccmd/$version"
          New-Item -ItemType Directory -Path $manifestDir -Force

      - name: Create winget version manifest
        run: |
          $version = "${{ needs.build.outputs.new_tag }}"
          $manifestDir = "winget/manifests/a/adamtheturtle/doccmd/$version"
          @"
          # yaml-language-server: `$schema=https://aka.ms/winget-manifest.version.1.6.0.schema.json
          PackageIdentifier: adamtheturtle.doccmd
          PackageVersion: $version
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.6.0
          "@ | Out-File -FilePath "$manifestDir/adamtheturtle.doccmd.yaml" -Encoding utf8NoBOM

      - name: Create winget locale manifest
        run: |
          $version = "${{ needs.build.outputs.new_tag }}"
          $manifestDir = "winget/manifests/a/adamtheturtle/doccmd/$version"
          @"
          # yaml-language-server: `$schema=https://aka.ms/winget-manifest.defaultLocale.1.6.0.schema.json
          PackageIdentifier: adamtheturtle.doccmd
          PackageVersion: $version
          PackageLocale: en-US
          Publisher: Adam Dangoor
          PublisherUrl: https://github.com/adamtheturtle
          PublisherSupportUrl: https://github.com/adamtheturtle/doccmd/issues
          Author: Adam Dangoor
          PackageName: doccmd
          PackageUrl: https://github.com/adamtheturtle/doccmd
          License: MIT
          LicenseUrl: https://github.com/adamtheturtle/doccmd/blob/main/LICENSE
          Copyright: Copyright (c) Adam Dangoor
          ShortDescription: Run tools against code blocks in documentation
          Description: A command line tool for running commands against code blocks in documentation files. This allows you to run linters, formatters, and other tools against the code blocks in your documentation files.
          Moniker: doccmd
          Tags:
            - cli
            - documentation
            - linter
            - markdown
            - python
            - restructuredtext
          ReleaseNotesUrl: https://github.com/adamtheturtle/doccmd/releases/tag/$version
          ManifestType: defaultLocale
          ManifestVersion: 1.6.0
          "@ | Out-File -FilePath "$manifestDir/adamtheturtle.doccmd.locale.en-US.yaml" -Encoding utf8NoBOM

      - name: Create winget installer manifest
        run: |
          $version = "${{ needs.build.outputs.new_tag }}"
          $sha256 = "${{ steps.sha256.outputs.hash }}"
          $manifestDir = "winget/manifests/a/adamtheturtle/doccmd/$version"
          @"
          # yaml-language-server: `$schema=https://aka.ms/winget-manifest.installer.1.6.0.schema.json
          PackageIdentifier: adamtheturtle.doccmd
          PackageVersion: $version
          InstallerType: portable
          Commands:
            - doccmd
          Installers:
            - Architecture: x64
              InstallerUrl: https://github.com/adamtheturtle/doccmd/releases/download/$version/doccmd-windows.exe
              InstallerSha256: $sha256
          ManifestType: installer
          ManifestVersion: 1.6.0
          "@ | Out-File -FilePath "$manifestDir/adamtheturtle.doccmd.installer.yaml" -Encoding utf8NoBOM

      - name: Install winget-create and validate manifest
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe
          $version = "${{ needs.build.outputs.new_tag }}"
          .\wingetcreate.exe validate "winget/manifests/a/adamtheturtle/doccmd/$version"

      - name: Commit and push winget manifest
        run: |
          git config user.name "adamtheturtle"
          git config user.email "adamdangoor@gmail.com"
          $version = "${{ needs.build.outputs.new_tag }}"
          git add "winget/manifests/a/adamtheturtle/doccmd/$version"
          git commit -m "Add winget manifest for version $version"
          git push origin main
